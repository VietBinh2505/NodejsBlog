<% include ./../../helpers/format-date.ejs %>
<% include ./../../helpers/show-message-chat.ejs %>
<% 
	folderUpload = "upload/users/";
	const linkPrefix = systemConfig.prefixChat + "/"; //
%>
<div class="box box-primary direct-chat direct-chat-primary">
	<div class="box-header with-border">
		<h3 class="box-title">Direct Chat</h3>
	</div>
	<div class="box-body">
		<div class="direct-chat-messages" id="area-list-message">
			<%- showMessageChat(message, userData) %>
		</div>
	</div>
	<div class="box-footer">
		<form action="/" method="post" id="form-chat">
			<div class="input-group">
				<input type="text" name="message" id="message" placeholder="Type Message ..." class="form-control">
				<input type="hidden" name="username" value="<%= userData.username %>">
				<input type="hidden" name="avatar" value="<%= userData.avatar %>">
				<span class="input-group-btn">
					<button type="submit" class="btn btn-primary btn-flat">Send</button>
				</span>
			</div>
		</form>
	</div>
</div>
<script type="text/javascript">
	$(function () {
		let elmInputMessage = $('input#message');
		let elmInputUsername = $('input[name="username"]');
		let elmInputAvatar = $('input[name="avatar"]');
		let elmFormChat = $("form#form-chat");
		let elmlistMessage = $("div#area-list-message");

		let socket = io.connect("http://localhost:2505");
		socket.on("server_return_newMessage", (data) => {
			let userAvatar = "upload/users/" + data.avatar;
			let typeShow = "";
            let classUsername = "pull-left";
            let classCreated = "pull-right";

            if(elmInputUsername.val() == data.username ){
					typeShow        = "right";
					classUsername   = "pull-right";
					classCreated    = "pull-left";
            }
			let xhtmlChat = `<div class="direct-chat-msg ${typeShow}">
               <div class="direct-chat-info clearfix">
                  <span class="direct-chat-name ${classUsername}">${data.username}</span>
                  <span class="direct-chat-timestamp ${classCreated}">${data.created}</span>
               </div>
               <img class="direct-chat-img" src="${userAvatar}" alt="${data.username}">
               <div class="direct-chat-text">${data.content}</div>
				</div>`;
			elmlistMessage.append(xhtmlChat);
		});
		elmFormChat.submit(function () {
			socket.emit("client_send_all_message", {
				content: elmInputMessage.val(),
				username: elmInputUsername.val(),
				avatar: elmInputAvatar.val(),
			});
			elmInputMessage.val("");
			return false;
		});
	});
</script>